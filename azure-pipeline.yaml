trigger:
  - master

pool:
  name: wsl

steps:

  ## TERRAFORM
  - script: terraform init --backend-config backend.tfvars
    displayName:  Terraform init
    workingDirectory: $(Build.SourcesDirectory)/terraform
    env:
      ARM_CLIENT_ID: $(ARM_CLIENT_ID)
      ARM_CLIENT_SECRET: $(ARM_CLIENT_SECRET)
      ARM_SUBSCRIPTION_ID: $(ARM_SUBSCRIPTION_ID)
      ARM_TENANT_ID: $(ARM_TENANT_ID)
      ARM_ACCESS_KEY: $(ARM_ACCESS_KEY)

  - script: terraform plan
    displayName:  Terraform plan
    workingDirectory: $(Build.SourcesDirectory)/terraform
    env:
      ARM_CLIENT_ID: $(ARM_CLIENT_ID)
      ARM_CLIENT_SECRET: $(ARM_CLIENT_SECRET)
      ARM_SUBSCRIPTION_ID: $(ARM_SUBSCRIPTION_ID)
      ARM_TENANT_ID: $(ARM_TENANT_ID)
      ARM_ACCESS_KEY: $(ARM_ACCESS_KEY)

  - script: terraform apply -auto-approve
    displayName:  Terraform apply
    workingDirectory: $(Build.SourcesDirectory)/terraform
    env:
      ARM_CLIENT_ID: $(ARM_CLIENT_ID)
      ARM_CLIENT_SECRET: $(ARM_CLIENT_SECRET)
      ARM_SUBSCRIPTION_ID: $(ARM_SUBSCRIPTION_ID)
      ARM_TENANT_ID: $(ARM_TENANT_ID)
      ARM_ACCESS_KEY: $(ARM_ACCESS_KEY)



  ## ANSIBLE - venv
  - script: |
      sudo apt-get update && sudo apt-get install -y python3-venv
      python3 -m venv venv
      ./venv/bin/pip install --upgrade pip
      ./venv/bin/pip install -r requirements-azure.txt
      ./venv/bin/pip install "ansible[azure]==2.8.6"
    displayName: Get requirements
    workingDirectory: $(Build.SourcesDirectory)/ansible

  ## ANSIBLE - run
  - script: |
      source venv/bin/activate
      ansible-playbook playbookdemo.yml -i inv.azure_rm.yml
    displayName: Ansible playbook
    workingDirectory: $(Build.SourcesDirectory)/ansible
    env:
      AZURE_CLIENT_ID: $(ARM_CLIENT_ID)
      AZURE_SECRET: $(ARM_CLIENT_SECRET)
      AZURE_SUBSCRIPTION_ID: $(ARM_SUBSCRIPTION_ID)
      AZURE_TENANT: $(ARM_TENANT_ID)
      ANSIBLE_HOST_KEY_CHECKING: False

  - task: Bash@3
    displayName: Terraform destroy on failure
    condition: failed()
    inputs:
      targetType: inline
      script: terraform destroy -auto-approve
